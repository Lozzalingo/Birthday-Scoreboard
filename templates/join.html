{% extends "base.html" %}

{% block title %}Join Game - Birthday Scoreboard{% endblock %}

{% block content %}
<div class="join-container">
    <div class="join-form-section">
        <h2>üéÆ Join the Game</h2>

        <div class="form-container">
            <form id="join-form" class="join-form">
                <div class="form-group">
                    <label for="team-name">Team Name:</label>
                    <input type="text" id="team-name" name="team-name" required maxlength="50"
                           placeholder="Enter your team name">
                </div>
                <button type="submit" class="btn btn-primary btn-large">üöÄ Join Game</button>
            </form>
        </div>

        <div id="success-message" class="success-message" style="display: none;">
            <h3>üéâ Welcome to the game!</h3>
            <p>You've successfully joined. You can now update your score and team name below.</p>
        </div>
    </div>

    <div class="player-controls" id="player-controls" style="display: none;">
        <div class="controls-header">
            <h3>üéØ Your Controls</h3>
            <div class="view-toggle">
                <button id="view-leaderboard-btn" class="btn btn-secondary">üìä View Leaderboard</button>
                <button id="view-controls-btn" class="btn btn-primary" style="display: none;">‚öôÔ∏è Edit Team</button>
            </div>
        </div>

        <div class="control-group">
            <label for="current-team-name">Team Name:</label>
            <div class="input-group">
                <input type="text" id="current-team-name" maxlength="50">
                <button id="update-name-btn" class="btn btn-secondary">Update</button>
            </div>
        </div>

        <div class="control-group">
            <label for="current-score">Score:</label>
            <div class="input-group">
                <input type="number" id="current-score" min="0" step="0.5">
                <button id="update-score-btn" class="btn btn-primary">Update</button>
            </div>
        </div>

        <div class="quick-score-buttons">
            <button class="btn btn-small" onclick="addToScore(0.5)">+0.5</button>
            <button class="btn btn-small" onclick="addToScore(1)">+1</button>
            <button class="btn btn-small" onclick="addToScore(5)">+5</button>
            <button class="btn btn-small" onclick="addToScore(10)">+10</button>
            <button class="btn btn-small btn-danger" onclick="addToScore(-0.5)">-0.5</button>
            <button class="btn btn-small btn-danger" onclick="addToScore(-1)">-1</button>
        </div>
    </div>

    <div class="mini-leaderboard-section">
        <h3>üèÜ Current Standings</h3>
        <div class="mini-leaderboard" id="join-mini-leaderboard">
            <div class="no-teams">
                <p>Loading...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const socket = io();
    let playerTeamId = {% if existing_team %}{{ existing_team.id }}{% else %}null{% endif %};
    let currentTeam = {% if existing_team %}{{ existing_team | tojson }}{% else %}null{% endif %};

    // Fetch current team from server session
    async function fetchMyTeam() {
        try {
            const response = await fetch('/api/my-team');
            const data = await response.json();
            if (data.success) {
                playerTeamId = data.team.id;
                currentTeam = data.team;
                return data.team;
            }
            return null;
        } catch (error) {
            console.error('Error fetching team:', error);
            return null;
        }
    }

    socket.on('connect', function() {
        socket.emit('request_leaderboard');

        // Check for existing team on connect
        fetchMyTeam().then(team => {
            if (team) {
                console.log('Found existing team:', team);
                showPlayerControls();
                // Populate form with team data
                document.getElementById('current-team-name').value = team.name;
                document.getElementById('current-score').value = team.score;
                socket.emit('get_team_data');
            }
        });
    });

    // On page load, check if user already has a team
    window.addEventListener('load', function() {
        if (currentTeam) {
            console.log('Page load - server provided existing team:', currentTeam);
            // Hide join form immediately and show controls
            document.getElementById('join-form').style.display = 'none';
            document.getElementById('player-controls').style.display = 'block';
            // Populate form with team data
            document.getElementById('current-team-name').value = currentTeam.name;
            document.getElementById('current-score').value = currentTeam.score;
        } else {
            // Fallback: check via API
            fetchMyTeam().then(team => {
                if (team) {
                    console.log('Page load - API found team:', team);
                    // Hide join form immediately and show controls
                    document.getElementById('join-form').style.display = 'none';
                    document.getElementById('player-controls').style.display = 'block';
                    // Populate form with team data
                    document.getElementById('current-team-name').value = team.name;
                    document.getElementById('current-score').value = team.score;
                }
            });
        }
    });

    socket.on('team_joined', function(data) {
        playerTeamId = data.team_id;
        currentTeam = data;

        // Reset submit button
        const submitButton = document.querySelector('#join-form button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'üöÄ Join Game';
        }

        // Redirect to edit page
        if (data.redirect) {
            window.location.href = data.redirect;
        } else {
            // Fallback to showing controls
            showSuccessAndControls();
        }
    });

    socket.on('team_data', function(data) {
        if (data.team_id == playerTeamId) { // Use == for type coercion
            document.getElementById('current-team-name').value = data.team_name;
            document.getElementById('current-score').value = data.score;
            console.log('Team data loaded:', data);
        }
    });

    socket.on('leaderboard_update', function(data) {
        updateJoinMiniLeaderboard(data.teams);
    });

    socket.on('error', function(data) {
        console.log('Error received:', data.message);

        // If team not found, clear local data and show join form
        if (data.message === 'Team not found' || data.message === 'No team in session') {
            playerTeamId = null;
            currentTeam = null;
            document.getElementById('join-form').style.display = 'block';
            document.getElementById('player-controls').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
            alert('Your team was deleted by an admin. Please join again.');
            return;
        }

        // Reset submit button
        const submitButton = document.querySelector('#join-form button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'üöÄ Join Game';
        }

        alert('Error: ' + data.message);
    });

    document.getElementById('join-form').addEventListener('submit', function(e) {
        e.preventDefault();

        // Check if user already has a team
        if (playerTeamId || currentTeam) {
            alert('You already have a team! Use the "My Team" button to manage it.');
            window.location.href = '/';
            return;
        }

        const teamName = document.getElementById('team-name').value.trim();
        const submitButton = e.target.querySelector('button[type="submit"]');

        if (teamName) {
            // Disable button and show loading
            submitButton.disabled = true;
            submitButton.textContent = '‚è≥ Joining...';

            socket.emit('join_game', {team_name: teamName});

            // Re-enable after 5 seconds as fallback
            setTimeout(() => {
                if (submitButton.disabled) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'üöÄ Join Game';
                }
            }, 5000);
        }
    });

    document.getElementById('update-name-btn').addEventListener('click', function() {
        const newName = document.getElementById('current-team-name').value.trim();
        if (newName) {
            socket.emit('update_team_name', {team_name: newName});
        } else {
            alert('Team name is required');
        }
    });

    document.getElementById('update-score-btn').addEventListener('click', function() {
        const newScore = parseFloat(document.getElementById('current-score').value);
        if (!isNaN(newScore) && newScore >= 0) {
            socket.emit('update_score', {score: newScore});
        } else {
            alert('Invalid score - must be 0 or greater');
        }
    });

    function addToScore(points) {
        const currentScore = parseFloat(document.getElementById('current-score').value) || 0;
        const newScore = Math.max(0, currentScore + points);
        document.getElementById('current-score').value = newScore;

        socket.emit('update_score', {score: newScore});
    }

    function showSuccessAndControls() {
        document.getElementById('join-form').style.display = 'none';
        document.getElementById('success-message').style.display = 'block';
        document.getElementById('player-controls').style.display = 'block';
    }

    function showPlayerControls() {
        document.getElementById('join-form').style.display = 'none';
        document.getElementById('player-controls').style.display = 'block';
    }

    // Toggle between leaderboard and controls view
    document.getElementById('view-leaderboard-btn').addEventListener('click', function() {
        window.location.href = '/';
    });

    // Future: Add edit mode toggle if needed
    document.getElementById('view-controls-btn').addEventListener('click', function() {
        // Show controls, hide leaderboard (if we implement inline view)
        alert('Controls are already visible on this page!');
    });

    function updateJoinMiniLeaderboard(teams) {
        const miniLeaderboard = document.getElementById('join-mini-leaderboard');
        miniLeaderboard.innerHTML = '';

        if (teams.length === 0) {
            const noTeams = document.createElement('div');
            noTeams.className = 'no-teams';
            noTeams.innerHTML = '<p>No teams yet!</p>';
            miniLeaderboard.appendChild(noTeams);
        } else {
            teams.sort((a, b) => b.score - a.score);

            teams.slice(0, 5).forEach((team, index) => {
                const entry = document.createElement('div');
                entry.className = 'mini-entry';
                if (team.id === playerTeamId) {
                    entry.classList.add('highlight');
                }
                entry.innerHTML = `
                    <span class="mini-rank">${getRankDisplay(index + 1)}</span>
                    <span class="mini-name">${escapeHtml(team.name)}</span>
                    <span class="mini-score">${formatScore(team.score)}</span>
                `;
                miniLeaderboard.appendChild(entry);
            });
        }
    }

    function getRankDisplay(rank) {
        if (rank === 1) return 'ü•á';
        if (rank === 2) return 'ü•à';
        if (rank === 3) return 'ü•â';
        return rank;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}